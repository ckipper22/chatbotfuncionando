// src/app/next_api/whatsapp/webhook/route.ts
import { consultarProduto } from '@/lib/services/api-confere-nota';
import { NextRequest, NextResponse } from 'next/server';
import { getGeminiService } from '../../../../lib/services/gemini-service';
import { getMedicamentoInfo, medicamentosData } from '../../../../../Lib/medicamentos_data';

// =========================================================================
// VARI√ÅVEIS E FUN√á√ïES AUXILIARES PARA ENVIO WHATSAPP
// =========================================================================

const FORMATOS_COMPROVADOS = [
  '+5555984557096',
  '5555984557096',
];

function converterParaFormatoFuncional(numeroOriginal: string): string[] {
  console.log('üéØ [CONVERT] Convertendo para formato funcional:', numeroOriginal);

  const numeroLimpo = numeroOriginal.replace(/\D/g, '');
  console.log('üéØ [CONVERT] N√∫mero limpo:', numeroLimpo);

  if (numeroLimpo === '555584557096') {
    const formatosFuncionais = [
      '+5555984557096',
      '5555984557096',
    ];
    console.log('üéØ [CONVERT] ‚úÖ Convertido para formatos funcionais (caso espec√≠fico):', formatosFuncionais);
    return formatosFuncionais;
  }

  let numeroConvertido = numeroLimpo;

  if (numeroLimpo.length === 12 && numeroLimpo.startsWith('55')) {
    const ddd = numeroLimpo.substring(2, 4);
    const numeroSemDDIeDDD = numeroLimpo.substring(4);
    if (numeroSemDDIeDDD.length === 8 && !['1','2','3','4','5'].includes(numeroSemDDIeDDD.charAt(0))) {
        numeroConvertido = '55' + ddd + '9' + numeroSemDDIeDDD;
        console.log('üéØ [CONVERT] ‚úÖ Adicionado 9 para celular brasileiro (heur√≠stica):', numeroConvertido);
    }
  }

  const formatosFinais = [
    '+' + numeroConvertido,
    numeroConvertido
  ];

  console.log('üéØ [CONVERT] Formatos finais a serem tentados (gen√©rico):', formatosFinais);
  return formatosFinais;
}

async function testarFormatosSequencial(numero: string, texto: string): Promise<string | null> {
  console.log('üß™ [SEQUENTIAL TEST] Iniciando teste sequencial para:', numero);

  const formatos = converterParaFormatoFuncional(numero);

  for (let i = 0; i < formatos.length; i++) {
    const formato = formatos[i];
    console.log(`üß™ [SEQUENTIAL TEST] Tentativa ${i + 1}/${formatos.length}: ${formato}`);

    const sucesso = await tentarEnvioUnico(formato, texto, i + 1);
    if (sucesso) {
      console.log(`‚úÖ [SEQUENTIAL TEST] SUCESSO no formato ${i + 1}: ${formato}`);
      return formato;
    }

    await new Promise(resolve => setTimeout(resolve, 300));
  }

  console.log('‚ùå [SEQUENTIAL TEST] Todos os formatos falharam');
  return null;
}

async function tentarEnvioUnico(numero: string, texto: string, tentativa: number): Promise<boolean> {
  try {
    console.log(`üì§ [SEND ${tentativa}] Tentando enviar para: ${numero}`);

    const payload = {
      messaging_product: 'whatsapp',
      recipient_type: 'individual',
      to: numero,
      type: 'text',
      text: {
        preview_url: false,
        body: texto.substring(0, 4096)
      }
    };

    console.log(`üìù [SEND ${tentativa}] Payload:`, JSON.stringify(payload, null, 2));

    const WHATSAPP_API_URL = `https://graph.facebook.com/v22.0/${process.env.WHATSAPP_PHONE_NUMBER_ID}/messages`;

    const response = await fetch(WHATSAPP_API_URL, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${process.env.WHATSAPP_ACCESS_TOKEN}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(payload),
    });

    const responseText = await response.text();

    console.log(`üì® [SEND ${tentativa}] Status: ${response.status}`);
    console.log(`üì® [SEND ${tentativa}] Response: ${responseText}`);

    if (response.ok) {
      console.log(`üéâ [SEND ${tentativa}] ‚úÖ SUCESSO para: ${numero}`);
      return true;
    } else {
      try {
        const errorData = JSON.parse(responseText);
        console.error(`üí• [SEND ${tentativa}] ‚ùå FALHA para: ${numero} - Status: ${response.status}, Erro:`, errorData);
      } catch (e) {
        console.error(`üí• [SEND ${tentativa}] ‚ùå FALHA para: ${numero} - Status: ${response.status}, Response: ${responseText}`);
      }
      return false;
    }

  } catch (error) {
    console.error(`‚ùå [SEND ${tentativa}] Erro de rede ou desconhecido para ${numero}:`, error);
    return false;
  }
}

async function enviarComFormatosCorretos(numeroOriginal: string, texto: string): Promise<boolean> {
  try {
    console.log('üéØ [SEND FIXED] Usando formatos comprovadamente funcionais para:', numeroOriginal);

    const formatoFuncional = await testarFormatosSequencial(numeroOriginal, texto);

    if (formatoFuncional) {
      console.log(`‚úÖ [SEND FIXED] Mensagem enviada com sucesso usando formato: ${formatoFuncional}`);
      return true;
    } else {
      console.log(`‚ùå [SEND FIXED] N√£o foi poss√≠vel enviar para nenhum formato de: ${numeroOriginal}`);
      return false;
    }

  } catch (error) {
    console.error('‚ùå [SEND FIXED] Erro cr√≠tico no envio:', error);
    return false;
  }
}

// =========================================================================
// FUN√á√ïES AUXILIARES PARA PROCESSAMENTO DE MENSAGENS
// =========================================================================

function parseUserMessageForDrugInfo(message: string): { drugName?: string; infoType?: string } {
  const lowerMessage = message.toLowerCase();
  let drugName: string | undefined;
  let infoType: string | undefined;

  const infoTypeKeywords: { [key: string]: string[] } = {
    "classe terapeutica": ["classe terapeutica", "classe farmacologica", "categoria", "grupo de medicamentos", "tipo de remedio"],
    "posologia": ["posologia", "dose", "como usar", "modo de usar", "dosagem", "quantas vezes", "como tomar"],
    "indicacoes": ["indicacoes", "para que serve", "usos", "quando usar", "utilizacao", "beneficios"],
    "efeitos colaterais": ["efeitos colaterais", "reacoes adversas", "colaterais", "o que pode causar", "problemas", "efeitos indesejados"],
    "contraindicacoes": ["contraindicacoes", "contra indicado", "nao usar quando", "quem nao pode usar", "restricoes", "quando nao usar", "proibido"],
    "mecanismo de acao": ["mecanismo de acao", "como funciona", "acao do remedio", "age no organismo", "mecanismo"],
    "interacoes medicamentosas": ["interacoes medicamentosas", "pode misturar com", "outros remedios", "combinar com", "interage com", "interagir"],
    "tudo": ["tudo", "informacoes completas", "tudo sobre", "informacoes gerais", "ficha completa", "informacao completa"],
  };

  for (const typeKey in infoTypeKeywords) {
    if (infoTypeKeywords[typeKey].some(keyword => lowerMessage.includes(keyword))) {
      infoType = typeKey;
      break;
    }
  }

  const allDrugNames = medicamentosData.map(m => m["Nome do Medicamento"].toLowerCase());
  let bestMatchDrug: string | undefined;
  let bestMatchLength = 0;

  for (const drug of allDrugNames) {
    if (lowerMessage.includes(drug) && drug.length > bestMatchLength) {
      bestMatchDrug = drug;
      bestMatchLength = drug.length;
    }
  }
  drugName = bestMatchDrug;

  return { drugName, infoType };
}

// =========================================================================
// ROTA NEXT.JS API - WEBHOOK PARA WHATSAPP BUSINESS API
// =========================================================================

console.log('üéØ [COMPLETE SYSTEM] Sistema completo com IA ativada!');
console.log('‚úÖ [FORMATS] Formatos que funcionam:', FORMATOS_COMPROVADOS);
console.log('üìä [CONFIG] Status completo:');
console.log('   WEBHOOK_TOKEN:', process.env.WHATSAPP_WEBHOOK_VERIFY_TOKEN ? '‚úÖ' : '‚ùå');
console.log('   PHONE_ID:', process.env.WHATSAPP_PHONE_NUMBER_ID || '‚ùå');
console.log('   ACCESS_TOKEN:', process.env.WHATSAPP_ACCESS_TOKEN ? '‚úÖ' : '‚ùå');
console.log('   GEMINI_API_KEY:', process.env.GEMINI_API_KEY ? '‚úÖ IA ATIVADA!' : '‚ùå IA DESATIVADA');

export async function GET(request: NextRequest) {
  const searchParams = request.nextUrl.searchParams;
  const mode = searchParams.get('hub.mode');
  const token = searchParams.get('hub.verify_token');
  const challenge = searchParams.get('hub.challenge');

  console.log('üîê [WEBHOOK VERIFICATION] Verifica√ß√£o do webhook:', {
    mode,
    tokenMatch: token === process.env.WHATSAPP_WEBHOOK_VERIFY_TOKEN,
    challenge: challenge?.substring(0, 20) + '...'
  });

  if (mode === 'subscribe' && token === process.env.WHATSAPP_WEBHOOK_VERIFY_TOKEN) {
    console.log('‚úÖ [WEBHOOK] Verifica√ß√£o bem-sucedida!');
    return new NextResponse(challenge, {
      status: 200,
      headers: {
        'Content-Type': 'text/plain',
        'Cache-Control': 'no-cache'
      }
    });
  }

  console.log('‚ùå [WEBHOOK] Verifica√ß√£o falhou');
  return NextResponse.json({ error: 'Forbidden' }, { status: 403 });
}

export async function POST(request: NextRequest) {
  try {
    console.log('üì® [WEBHOOK] Nova mensagem recebida');

    if (!process.env.WHATSAPP_PHONE_NUMBER_ID || !process.env.WHATSAPP_ACCESS_TOKEN) {
      console.error('‚ùå [WEBHOOK] Configura√ß√£o cr√≠tica faltando: WHATSAPP_PHONE_NUMBER_ID ou WHATSAPP_ACCESS_TOKEN');
      return NextResponse.json({ error: 'Configuration error' }, { status: 500 });
    }

    const body = await request.json();
    console.log('üì¶ [WEBHOOK] Payload recebido:', JSON.stringify(body, null, 2));

    const value = body.entry?.[0]?.changes?.[0]?.value;

    if (value?.statuses) {
      const status = value.statuses[0]?.status;
      console.log('üìä [STATUS] Status de entrega recebido:', status);
      return NextResponse.json({ status: 'ok' }, { status: 200 });
    }

    const messages = value?.messages;
    if (!messages?.length) {
      console.log('‚ÑπÔ∏è [WEBHOOK] Nenhuma mensagem para processar ou tipo inv√°lido');
      return NextResponse.json({ status: 'ok' }, { status: 200 });
    }

    console.log(`üîÑ [WEBHOOK] Processando ${messages.length} mensagem(ns)`);

    for (const message of messages) {
      await processarComIACompleta(message);
    }

    return NextResponse.json({ status: 'ok' }, { status: 200 });

  } catch (error) {
    console.error('‚ùå [WEBHOOK] Erro cr√≠tico no sistema:', error);
    return NextResponse.json({ error: 'Internal server error' }, { status: 500 });
  }
}

// ü§ñ PROCESSAMENTO COMPLETO COM IA E FALLBACK
async function processarComIACompleta(message: any): Promise<void> {
  const { from, text, type, id } = message;

  console.log('   [AI PROCESS] Processando com IA completa:', {
    from,
    type,
    messageId: id,
    hasText: !!text?.body
  });

  try {
    if (type !== 'text' || !text?.body) {
      console.log('‚ö†Ô∏è [AI PROCESS] Mensagem ignorada (n√£o √© texto)');
      return;
    }

    const userMessage = text.body.trim();
    const lowerMessage = userMessage.toLowerCase();

    console.log(`   [AI PROCESS] De ${from}: "${userMessage}"`);

    const geminiService = getGeminiService();

    // üëáüëáüëá CONSULTA DE PRODUTOS - ADICIONADO AQUI üëáüëáüëá
    if (lowerMessage.startsWith('buscar ') ||
        lowerMessage.startsWith('produto ') ||
        lowerMessage.startsWith('consulta ') ||
        lowerMessage.startsWith('pre√ßo ') ||
        lowerMessage.startsWith('preco ') ||
        lowerMessage.startsWith('estoque ')) {

      console.log(`üõçÔ∏è [PRODUTO] Consultando produto: "${userMessage}"`);

      try {
        const termoBusca = userMessage.replace(/^(buscar|produto|consulta|pre√ßo|preco|estoque)\s*/i, '').trim();

        if (termoBusca.length < 2) {
          await enviarComFormatosCorretos(from,
            `üîç *BUSCA DE PRODUTOS*\\n\\n` +
            `Por favor, digite o nome do produto que deseja buscar (m√≠nimo 2 caracteres).\\n\\n` +
            `üí° *Exemplos:*\\n` +
            `‚Ä¢ *buscar paracetamol*\\n` +
            `‚Ä¢ *produto dipirona*\\n` +
            `‚Ä¢ *estoque nimesulida*`
          );
          return;
        }

        const resultado = await consultarProduto(termoBusca);

        if (!resultado.success || resultado.count === 0) {
          await enviarComFormatosCorretos(from,
            `‚ùå *PRODUTO N√ÉO ENCONTRADO*\\n\\n` +
            `N√£o encontrei produtos para "*${termoBusca}*".\\n\\n` +
            `üí° *Sugest√µes:*\\n` +
            `‚Ä¢ Verifique a ortografia\\n` +
            `‚Ä¢ Tente um termo mais espec√≠fico\\n` +
            `‚Ä¢ Use apenas o nome principal`
          );
          return;
        }

        let resposta = `üîç *${resultado.count} PRODUTO(S) ENCONTRADO(S)*\\n` +
                      `*Busca:* "${termoBusca}"\\n\\n`;

        resultado.data.slice(0, 5).forEach((produto: any, index: number) => {
          resposta += `*${index + 1}. ${produto.nome_produto}*\\n`;
          resposta += `üíä ${produto.nom_laboratorio}\\n`;
          resposta += `üí∞ ${produto.preco_final_venda}`;
          if (produto.desconto_percentual > 0) {
            resposta += ` (üîª${produto.desconto_percentual.toFixed(1)}% OFF)`;
          }
          resposta += `\\nüì¶ Estoque: ${produto.qtd_estoque} unidades\\n`;
          resposta += `üìã C√≥digo: ${produto.cod_reduzido}\\n\\n`;
        });

        if (resultado.count > 5) {
          resposta += `üìä *E mais ${resultado.count - 5} produtos...*\\n`;
          resposta += `Use um termo mais espec√≠fico para ver todos.\\n\\n`;
        }

        resposta += `üí° *Dica:* Use *"c√≥digo 12345"* para detalhes de um produto espec√≠fico.`;

        await enviarComFormatosCorretos(from, resposta);
        return;

      } catch (error) {
        console.error('‚ùå [PRODUTO] Erro na consulta:', error);
        await enviarComFormatosCorretos(from,
          `‚ö†Ô∏è *ERRO NA CONSULTA*\\n\\n` +
          `N√£o consegui buscar produtos no momento.\\n` +
          `Nossa equipe foi notificada.\\n\\n` +
          `Tente novamente em alguns instantes.`
        );
        return;
      }
    }
    // üëÜüëÜüëÜ FIM DA CONSULTA DE PRODUTOS üëÜüëÜüëÜ

    // Comandos administrativos
    if (lowerMessage === '/test' || lowerMessage === 'test') {
      const statusIA = process.env.GEMINI_API_KEY ? 'ü§ñ IA ATIVA' : '‚ö†Ô∏è IA INATIVA';
      const statusMsg = `‚úÖ *SISTEMA COMPLETO FUNCIONANDO!*\\n\\nüîó WhatsApp: ‚úÖ Conectado\\n${statusIA}\\nüõçÔ∏è Produtos: ‚úÖ API Conectada\\nüìä Formatos: ‚úÖ Corretos\\nüöÄ Status: 100% Operacional\\n\\nTudo funcionando perfeitamente!`;
      await enviarComFormatosCorretos(from, statusMsg);
      return;
    }

    if (lowerMessage === '/debug' || lowerMessage === 'debug') {
      const formatos = converterParaFormatoFuncional(from);
      const statusIA = process.env.GEMINI_API_KEY ? '‚úÖ ATIVA' : '‚ùå INATIVA';
      const debugInfo = `üîß *DEBUG SISTEMA COMPLETO*\\n\\nüì± Seu n√∫mero: ${from}\\nüéØ Convertido para:\\n‚Ä¢ ${formatos[0]}\\n‚Ä¢ ${formatos[1]}\\n\\nü§ñ IA Status: ${statusIA}\\nüõçÔ∏è API Produtos: ‚úÖ Conectada\\nüìä Formatos: ${FORMATOS_COMPROVADOS.length} testados\\n‚úÖ Sistema: 100% Operacional\\n\\nüöÄ *TUDO FUNCIONANDO!*`;
      await enviarComFormatosCorretos(from, debugInfo);
      return;
    }

    if (lowerMessage === '/limpar' || lowerMessage === 'limpar') {
      try {
        if (process.env.GEMINI_API_KEY) {
          geminiService.clearHistory(from);
          await enviarComFormatosCorretos(from, 'üóëÔ∏è *HIST√ìRICO LIMPO!*\\n\\nMem√≥ria da IA resetada com sucesso.\\nVamos come√ßar uma nova conversa! üöÄ');
        } else {
          await enviarComFormatosCorretos(from, 'üóëÔ∏è *COMANDO RECEBIDO!*\\n\\nIA ser√° ativada em breve.\\nSistema WhatsApp funcionando normalmente.');
        }
      } catch (error) {
        console.error('‚ùå [LIMPAR] Erro:', error);
        await enviarComFormatosCorretos(from, '‚ùå Erro ao limpar hist√≥rico.\\nSistema continua funcionando normalmente.');
      }
      return;
    }

    if (lowerMessage === '/ajuda' || lowerMessage === 'ajuda' || lowerMessage === '/help') {
      const statusIA = process.env.GEMINI_API_KEY ? 'ü§ñ IA totalmente ativa - Posso conversar sobre qualquer assunto!' : '‚öôÔ∏è IA sendo configurada';
      const helpMsg = `ü§ñ *ASSISTENTE INTELIGENTE ATIVO*\\n\\n` +
        `üõçÔ∏è *buscar [produto]* - Consulta produtos em estoque\\n` +
        `‚úÖ */test* - Status do sistema\\n` +
        `üîß */debug* - Informa√ß√µes t√©cnicas\\n` +
        `üóëÔ∏è */limpar* - Resetar conversa\\n` +
        `‚ùì */ajuda* - Esta mensagem\\n\\n` +
        `${statusIA}\\n\\n` +
        `üí¨ *Como usar:*\\n` +
        `Envie qualquer mensagem para conversar comigo!\\n` +
        `Sou um assistente inteligente pronto para ajudar.\\n\\n` +
        `üöÄ *STATUS: TOTALMENTE OPERACIONAL*`;
      await enviarComFormatosCorretos(from, helpMsg);
      return;
    }

    // Processamento com Intelig√™ncia Artificial
    if (!process.env.GEMINI_API_KEY) {
      console.log('‚ö†Ô∏è [AI PROCESS] GEMINI_API_KEY n√£o encontrada');
      await enviarComFormatosCorretos(from, 'ü§ñ *ASSISTENTE QUASE PRONTO!*\\n\\nSistema WhatsApp: ‚úÖ Funcionando perfeitamente\\nüõçÔ∏è Produtos: ‚úÖ API Conectada\\nIA: ‚öôÔ∏è Sendo configurada\\n\\nEm breve estarei conversando inteligentemente!\\nUse */test* para verificar status.');
      return;
    }

    let aiResponseText: string;
    try {
      console.log('ü§ñ [AI] Iniciando processamento com Gemini IA...');
      aiResponseText = await geminiService.generateResponse(userMessage, from);
      console.log(`ü§ñ [AI] Resposta da IA gerada com sucesso (${aiResponseText.length} caracteres)`);
    } catch (aiError: any) {
      console.error('‚ùå [AI] Erro na intelig√™ncia artificial:', aiError);
      if (aiError.response && aiError.response.promptFeedback && aiError.response.promptFeedback.blockReason) {
        console.warn(`‚ö†Ô∏è Gemini API bloqueou o prompt: ${aiError.response.promptFeedback.blockReason}. For√ßando fallback de medicamentos.`);
        aiResponseText = "Aten√ß√£o (Pol√≠tica de Conte√∫do da IA)";
      } else {
        const errorMsg = `ü§ñ *ASSISTENTE TEMPORARIAMENTE INDISPON√çVEL*\\n\\n` +
          `Estou com dificuldades moment√¢neas para processar sua mensagem.\\n\\n` +
          `üí° *Sugest√µes:*\\n` +
          `‚Ä¢ Tente reformular sua pergunta\\n` +
          `‚Ä¢ Envie uma mensagem mais simples\\n` +
          `‚Ä¢ Use */test* para verificar o status\\n\\n` +
          `üîÑ Tentarei novamente em alguns instantes...`;
        await enviarComFormatosCorretos(from, errorMsg);
        return;
      }
    }

    const medicalDisclaimerPattern = /aten√ß√£o \(pol√≠tica de conte√∫do da ia\)|n√£o posso fornecer informa√ß√µes m√©dicas|n√£o sou um profissional de sa√∫de|n√£o estou qualificado para dar conselhos m√©dicos|consulte um m√©dico ou farmac√™utico/i;
    const isMedicalDisclaimer = medicalDisclaimerPattern.test(aiResponseText.toLowerCase());

    if (isMedicalDisclaimer) {
      console.log("‚û°Ô∏è LLM acionou o disclaimer m√©dico ou foi bloqueado. Tentando consultar a Lib/medicamentos_data.ts como fallback.");

      const parsedInfo = parseUserMessageForDrugInfo(userMessage);

      if (parsedInfo.drugName && parsedInfo.infoType) {
        console.log(`üîé Informa√ß√£o extra√≠da para fallback: Medicamento: '${parsedInfo.drugName}', Tipo: '${parsedInfo.infoType}'`);
        const libResult = getMedicamentoInfo(parsedInfo.drugName, parsedInfo.infoType);

        if (libResult.includes("N√£o encontrei informa√ß√µes sobre o medicamento") || libResult.includes("N√£o tenho a informa√ß√£o espec√≠fica sobre")) {
          const finalResponse = `_Aten√ß√£o (Pol√≠tica de Conte√∫do da IA)_ - Para sua seguran√ßa, por favor, consulte diretamente um *farmac√™utico* em nossa loja ou um *m√©dico*. Como assistente, n√£o posso fornecer informa√ß√µes ou recomenda√ß√µes m√©dicas. Tentei buscar em nossa base de dados interna, mas ${libResult.toLowerCase()}. Por favor, procure um profissional de sa√∫de para obter orienta√ß√£o.`;
          await enviarComFormatosCorretos(from, finalResponse);
        } else {
          const finalResponse = `_De acordo com nossa base de dados interna:_\\n\\n${libResult}\\n\\n*_Importante:_ Esta informa√ß√£o √© para fins educacionais e informativos e n√£o substitui o conselho, diagn√≥stico ou tratamento de um profissional de sa√∫de qualificado. Sempre consulte um *m√©dico* ou *farmac√™utico* para orienta√ß√µes espec√≠ficas sobre sua sa√∫de e para a interpreta√ß√£o correta das informa√ß√µes.`;
          await enviarComFormatosCorretos(from, finalResponse);
        }
      } else {
        console.warn("‚ö†Ô∏è N√£o foi poss√≠vel extrair nome do medicamento ou tipo de informa√ß√£o da mensagem do usu√°rio para o fallback.");
        const finalResponse = `_Aten√ß√£o (Pol√≠tica de Conte√∫do da IA)_ - Para sua seguran√ßa, por favor, consulte diretamente um *farmac√™utico* em nossa loja ou um *m√©dico*. Como assistente, n√£o posso fornecer informa√ß√µes ou recomenda√ß√µes m√©dicas. Tentei buscar em nossa base de dados interna, mas n√£o consegui entender qual medicamento ou informa√ß√£o espec√≠fica voc√™ procura. Por favor, tente perguntar de forma mais direta (ex: _'Qual a posologia da losartana?'_ ou _'Indica√ß√µes do paracetamol?'_).`;
        await enviarComFormatosCorretos(from, finalResponse);
      }
    } else {
      await enviarComFormatosCorretos(from, aiResponseText);
    }

  } catch (error) {
    console.error('‚ùå [AI PROCESS] Erro cr√≠tico no processamento:', error);

    const recoveryMsg = `‚ö†Ô∏è *ERRO TEMPOR√ÅRIO DETECTADO*\\n\\n` +
      `O sistema detectou um problema moment√¢neo e est√° se recuperando automaticamente.\\n\\n` +
      `üîÑ *A√ß√µes tomadas:*\\n` +
      `‚Ä¢ Reinicializa√ß√£o autom√°tica em andamento\\n` +
      `‚Ä¢ Sistema WhatsApp mantido ativo\\n` +
      `‚Ä¢ Logs de erro registrados\\n\\n` +
      `Use */test* para verificar o status de recupera√ß√£o.`;

    try {
      await enviarComFormatosCorretos(from, recoveryMsg);
    } catch (recoveryError) {
      console.error('‚ùå [RECOVERY] Falha cr√≠tica na recupera√ß√£o:', recoveryError);
    }
  }
}


# .env.local (na raiz do seu projeto)

# ===============================================
# VARI√ÅVEIS DE AMBIENTE PARA SUPABASE
# ===============================================

# O URL do seu projeto Supabase (Pode ser p√∫blico)
NEXT_PUBLIC_SUPABASE_URL="https://xmanikuremcrmmpkao.supabase.co"

# A chave p√∫blica "anon" do seu projeto Supabase (para o cliente)
NEXT_PUBLIC_SUPABASE_ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhtYW5pa3VyZW1jcm12bW1wa2FvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwNjU1OTMsImV4cCI6MjA3ODY0MTU5M30.DSJN4hhAnn_f8f1yisd6Vb6qtJD3lGZgIO-Zoe9UVfg"

# A chave "service_role" do seu projeto Supabase (para o servidor, MANTENHA SECRETA!)
SUPABASE_SERVICE_ROLE_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhtYW5pa3VyZW1jcm11bW1wa2FvIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2MzA2NTU5MywiZXhwIjoyMDc4NjQxNTkzfQ.OGNrjcWnXhPsSbVUtdx268Imszhz-xHQwtlVn6f9-g4"


# ===============================================
# VARI√ÅVEIS DE AMBIENTE PARA WHATSAPP
# ===============================================

# Token de verifica√ß√£o para o Webhook do WhatsApp (VOC√ä J√Å FORNECEU!)
WHATSAPP_WEBHOOK_VERIFY_TOKEN="meu_token_secreto_123"

# Access Token do WhatsApp (VOC√ä J√Å FORNECEU!)
WHATSAPP_ACCESS_TOKEN="EAALmzZClluwUBPZCpB0QMYh6K2ZC9QatRqJSbuvH9KdJm61KFGlvmeDMh2IuVP7RSKQDcaQJadReaLBYZBCLJB4xCDrXjkRcRWHvqbXHOlosPraJ78lbYPZA3Hc15ZC74ZBqowlZBjZBl4NeZBBZAvveY0ReCF64wb9SM8UJ8LNZCPWR4vjjZCPiKbHPSRgZDZD"


# ===============================================
# OUTRAS VARI√ÅVEIS
# ===============================================

# Chave de criptografia para a senha do banco de dados do cliente
# Se essa vari√°vel for usada em seu c√≥digo, voc√™ precisa definir um valor secreto para ela.
CLIENT_DB_PASSWORD_ENCRYPTION_KEY="### AQUI VOC√ä DEVE INSERIR UMA CHAVE SECRETA FORTE E ALEAT√ìRIA ###"

# Vari√°veis para dados do solicitante
DADOS_SOLICITANTE_RAJAO_SOCIAL="Carlos Kipper Ltda"
DADOS_SOLICITANTE_CNPJ="13.408.443/0001-68"
DADOS_SOLICITANTE_IE="090/0055324"
DADOS_SOLICITANTE_AFE="7216566"
DADOS_SOLICITANTE_ENDERECO="Avenida Presidente Kennedy, 1754 Bairro: Arco Iris, Panambi - RS, CEP 98280-000"
DADOS_SOLICITANTE_TEL="55 98455 7096"
DADOS_SOLICITANTE_EMAIL="ckipper22@gmail.com"
DADOS_SOLICITANTE_COD_REDE=1
DADOS_SOLICITANTE_COD_FILIAL=1

// Lib/medicamentos_data.ts

// Este arquivo cont√©m dados estruturados de bulas de medicamentos (Bul√°rio Est√°tico).
// Ele √© usado como fonte de consulta quando o LLM (Gemini) tem restri√ß√µes de seguran√ßa ou falha ao responder sobre medicamentos.

export interface MedicamentoBula {
    "Nome do Medicamento": string;
    "Princ√≠pio(s) Ativo(s)": string[];
    "Classe Farmacol√≥gica": string;
    "Mecanismo de A√ß√£o": string;
    "Indica√ß√µes": string;
    "Posologia": string;
    "Contraindica√ß√µes": string;
    "Efeitos Colaterais": string;
    "Advert√™ncias e Precau√ß√µes": string;
    "Intera√ß√µes Medicamentosas": string; // Novo campo adicionado conforme a necessidade
}

export const medicamentosData: MedicamentoBula[] = [ // Renomeado de bulasEstaticas para medicamentosData
    {
        "Nome do Medicamento": "Losartana",
        "Princ√≠pio(s) Ativo(s)": ["Losartana Pot√°ssica"],
        "Classe Farmacol√≥gica": "Antagonista do Receptor da Angiotensina II (ARA-II)",
        "Mecanismo de A√ß√£o": "A losartana atua bloqueando seletivamente os receptores AT1 da angiotensina II, impedindo a vasoconstri√ß√£o, a libera√ß√£o de aldosterona e outros efeitos da angiotensina II. Isso resulta em vasodilata√ß√£o, redu√ß√£o da press√£o arterial e diminui√ß√£o da reten√ß√£o de s√≥dio e √°gua.",
        "Indica√ß√µes": "Hipertens√£o arterial (press√£o alta), incluindo casos de hipertrofia ventricular esquerda; insufici√™ncia card√≠aca (para reduzir o risco de morbidade e mortalidade, especialmente em pacientes intolerantes a inibidores da ECA); prote√ß√£o renal em pacientes com diabetes tipo 2 e protein√∫ria (excre√ß√£o excessiva de prote√≠nas na urina) para retardar a progress√£o da doen√ßa renal.",
        "Posologia": "Adultos: A dose inicial usual para hipertens√£o √© de 50 mg, uma vez ao dia. Para insufici√™ncia card√≠aca, a dose inicial √© de 12,5 mg, uma vez ao dia. A dose pode ser ajustada pelo m√©dico, geralmente at√© 100 mg/dia, dependendo da resposta do paciente e da condi√ß√£o cl√≠nica. A administra√ß√£o pode ser feita com ou sem alimentos.",
        "Contraindica√ß√µes": "Hipersensibilidade conhecida √† losartana ou a qualquer componente da f√≥rmula; gravidez (especialmente no segundo e terceiro trimestres, devido ao risco de toxicidade fetal e neonatal); lacta√ß√£o; uso concomitante com alisquireno em pacientes com diabetes mellitus ou insufici√™ncia renal moderada a grave (GFR < 60 mL/min/1.73m¬≤), devido ao aumento do risco de hipotens√£o, hipercalemia e piora da fun√ß√£o renal.",
        "Efeitos Colaterais": "Os efeitos mais comuns incluem tontura, cefaleia e fadiga. Outros efeitos podem ser hipercalemia (aumento de pot√°ssio no sangue, devido √† inibi√ß√£o da aldosterona), hipotens√£o ortost√°tica, dor abdominal, diarreia e tosse (menos comum que com inibidores da ECA). Rea√ß√µes mais raras, mas graves, incluem angioedema (incha√ßo da face, l√°bios, l√≠ngua e/ou garganta) e altera√ß√µes da fun√ß√£o renal.",
        "Advert√™ncias e Precau√ß√µes": "√â fundamental monitorar a fun√ß√£o renal e os n√≠veis de pot√°ssio s√©rico, especialmente em pacientes com insufici√™ncia renal, insufici√™ncia card√≠aca, ou naqueles que utilizam diur√©ticos poupadores de pot√°ssio ou suplementos de pot√°ssio. Evitar o uso durante a gravidez e, se a gravidez for detectada, descontinuar o medicamento imediatamente. Usar com cautela em pacientes com estenose da art√©ria renal (risco de piora da fun√ß√£o renal) e em pacientes com deple√ß√£o de volume (desidrata√ß√£o), pois podem apresentar hipotens√£o sintom√°tica. Intera√ß√µes medicamentosas importantes incluem diur√©ticos poupadores de pot√°ssio, suplementos de pot√°ssio, AINEs (podem reduzir o efeito anti-hipertensivo e aumentar o risco de disfun√ß√£o renal) e l√≠tio (aumenta os n√≠veis s√©ricos de l√≠tio).",
        "Intera√ß√µes Medicamentosas": "Intera√ß√µes importantes incluem diur√©ticos poupadores de pot√°ssio, suplementos de pot√°ssio, AINEs (podem reduzir o efeito anti-hipertensivo e aumentar o risco de disfun√ß√£o renal) e l√≠tio (aumenta os n√≠veis s√©ricos de l√≠tio)."
    },
    {
        "Nome do Medicamento": "Sinvastatina",
        "Princ√≠pio(s) Ativo(s)": ["Sinvastatina"],
        "Classe Farmacol√≥gica": "Inibidor da HMG-CoA Redutase (Estatina)",
        "Mecanismo de A√ß√£o": "A sinvastatina atua inibindo competitivamente a enzima HMG-CoA redutase, que √© a enzima limitante da bioss√≠ntese do colesterol no f√≠gado. Ao reduzir a produ√ß√£o hep√°tica de colesterol, aumenta-se o n√∫mero de receptores de LDL na superf√≠cie das c√©lulas hep√°ticas, o que leva a uma maior capta√ß√£o e catabolismo do LDL-colesterol do sangue, resultando na redu√ß√£o dos n√≠veis de colesterol total, LDL-C e triglicer√≠deos e um leve aumento do HDL-C.",
        "Indica√ß√µes": "Hipercolesterolemia prim√°ria (colesterol alto) e dislipidemia mista, incluindo hipercolesterolemia familiar homozig√≥tica e heterozig√≥tica; hipertrigliceridemia isolada; preven√ß√£o de eventos cardiovasculares (infarto do mioc√°rdio, acidente vascular cerebral, necessidade de revasculariza√ß√£o) em pacientes de alto risco, como aqueles com doen√ßa arterial coronariana estabelecida, diabetes mellitus, doen√ßa vascular perif√©rica ou hist√≥rico de AVC. Tamb√©m indicada para redu√ß√£o do risco de morte por doen√ßa arterial coronariana.",
        "Posologia": "Adultos: A dose inicial usualmente varia de 10 mg a 40 mg, uma vez ao dia, preferencialmente √† noite. A administra√ß√£o noturna √© recomendada porque a bioss√≠ntese do colesterol √© mais ativa durante a noite. A dose pode ser ajustada pelo m√©dico a intervalos de 4 semanas ou mais, conforme a resposta do paciente e os n√≠veis-alvo de lip√≠dios. A dose m√°xima recomendada √© de 40 mg/dia para a maioria dos pacientes, embora doses mais altas (at√© 80 mg) possam ser usadas em situa√ß√µes espec√≠ficas e sob estrita supervis√£o m√©dica.",
        "Contraindica√ß√µes": "Hipersensibilidade √† sinvastatina ou a qualquer componente da f√≥rmula; doen√ßa hep√°tica ativa ou eleva√ß√µes persistentes e inexplic√°veis das transaminases s√©ricas (enzimas hep√°ticas); gravidez e lacta√ß√£o (devido ao potencial teratog√™nico e √† interrup√ß√£o da bioss√≠ntese de esteroides essenciais para o feto/lactente); uso concomitante de inibidores potentes da CYP3A4, como itraconazol, cetoconazol, posaconazol, voriconazol (antif√∫ngicos az√≥licos), eritromicina, claritromicina, telitromicina (antibi√≥ticos macrol√≠deos), inibidores da protease do HIV (ex: nelfinavir, atazanavir), boceprevir, telaprevir, nefazodona e gemfibrozila.",
        "Efeitos Colaterais": "Os efeitos mais comuns s√£o geralmente leves e transit√≥rios, incluindo mialgia (dor muscular), dor abdominal, constipa√ß√£o, flatul√™ncia e cefaleia. Efeitos mais graves, embora raros, incluem miopatia (fraqueza muscular com ou sem eleva√ß√£o de creatina quinase - CK), rabdomi√≥lise (les√£o muscular grave que pode levar √† insufici√™ncia renal aguda) e disfun√ß√£o hep√°tica (eleva√ß√£o das transaminases s√©ricas). √â crucial que o paciente relate qualquer dor muscular inexplic√°vel, sensibilidade ou fraqueza.",
        "Advert√™ncias e Precau√ß√µes": "√â essencial monitorar a fun√ß√£o hep√°tica (enzimas transaminases) antes do in√≠cio do tratamento e periodicamente durante o uso, especialmente se houver sintomas sugestivos de les√£o hep√°tica. Avaliar o risco de miopatia/rabdomi√≥lise, que √© aumentado em pacientes com fatores de risco (ex: idade avan√ßada, hipotireoidismo n√£o controlado, insufici√™ncia renal, uso concomitante de certos medicamentos). Recomenda-se evitar o consumo excessivo de √°lcool e sumo de toranja (grapefruit juice), pois este √∫ltimo pode aumentar significativamente os n√≠veis plasm√°ticos de sinvastatina, elevando o risco de efeitos adversos. Intera√ß√µes medicamentosas com amiodarona, verapamil, diltiazem e anlodipino tamb√©m requerem cautela e ajuste de dose da sinvastatina.",
        "Intera√ß√µes Medicamentosas": "Intera√ß√µes importantes com inibidores potentes da CYP3A4 (ex: antif√∫ngicos az√≥licos, antibi√≥ticos macrol√≠deos, inibidores da protease do HIV, nefazodona, gemfibrozila), amiodarona, verapamil, diltiazem e anlodipino."
    },
    {
        "Nome do Medicamento": "Diclofenaco",
        "Princ√≠pio(s) Ativo(s)": ["Diclofenaco S√≥dico", "Diclofenaco Pot√°ssico"],
        "Classe Farmacol√≥gica": "Anti-inflamat√≥rio N√£o Esteroidal (AINE)",
        "Mecanismo de A√ß√£o": "O diclofenaco exerce suas a√ß√µes analg√©sica, anti-inflamat√≥ria e antipir√©tica principalmente atrav√©s da inibi√ß√£o da bioss√≠ntese de prostaglandinas, que s√£o mediadores da inflama√ß√£o, dor e febre. Ele atua inibindo as enzimas ciclooxigenase-1 (COX-1) e ciclooxigenase-2 (COX-2). A inibi√ß√£o da COX-1 est√° associada a efeitos gastrointestinais, enquanto a inibi√ß√£o da COX-2 √© respons√°vel pelos efeitos anti-inflamat√≥rios e analg√©sicos. O diclofenaco pot√°ssico tem um in√≠cio de a√ß√£o mais r√°pido que o s√≥dico, sendo prefer√≠vel para dor aguda.",
        "Indica√ß√µes": "Tratamento de dores agudas e cr√¥nicas de diversas origens (ex: dor p√≥s-operat√≥ria, dor de dente, c√≥lica menstrual, dor lombar, dor musculoesquel√©tica), inflama√ß√£o em condi√ß√µes como artrite reumatoide, osteoartrite, espondilite anquilosante, gota aguda, e tamb√©m para o controle da febre (em algumas formula√ß√µes e indica√ß√µes espec√≠ficas).",
        "Posologia": "Adultos: A dose varia amplamente de 50 mg a 150 mg por dia, divididos em 2 ou 3 doses, dependendo da formula√ß√£o (comprimidos, c√°psulas, gotas, injet√°veis, suposit√≥rios, g√©is t√≥picos) e da condi√ß√£o a ser tratada. √â crucial utilizar a menor dose eficaz pelo menor tempo poss√≠vel para minimizar os riscos de efeitos adversos. Para dor aguda, o diclofenaco pot√°ssico pode ser administrado em doses de 25-50 mg a cada 6-8 horas.",
        "Contraindica√ß√µes": "Hipersensibilidade conhecida ao diclofenaco, a outros AINEs (incluindo aspirina) ou a qualquer componente da f√≥rmula; √∫lcera p√©ptica ativa ou hist√≥rico de sangramento/perfura√ß√£o gastrointestinal; insufici√™ncia card√≠aca grave; insufici√™ncia hep√°tica ou renal grave; gravidez (especialmente no terceiro trimestre, devido ao risco de fechamento prematuro do ducto arterioso fetal e disfun√ß√£o renal fetal); asma, urtic√°ria ou rinite aguda precipitadas por AINEs; hist√≥rico de eventos tromboemb√≥licos ou doen√ßa cardiovascular grave.",
        "Efeitos Colaterais": "Os efeitos mais comuns incluem dist√∫rbios gastrointestinais, como dor epig√°strica, n√°useas, v√¥mitos, diarreia, dispepsia, dor abdominal e flatul√™ncia. Efeitos mais graves incluem √∫lcera gastrointestinal, sangramento ou perfura√ß√£o (que podem ser fatais, especialmente em idosos), eventos tromb√≥ticos cardiovasculares (infarto do mioc√°rdio, acidente vascular cerebral), insufici√™ncia renal aguda, eleva√ß√£o das enzimas hep√°ticas e rea√ß√µes cut√¢neas graves (ex: s√≠ndrome de Stevens-Johnson).",
        "Advert√™ncias e Precau√ß√µes": "Devido ao risco de eventos gastrointestinais graves (sangramento, ulcera√ß√£o, perfura√ß√£o), cardiovasculares (trombose, infarto do mioc√°rdio, AVC) e renais (insufici√™ncia renal aguda), o diclofenaco deve ser usado com extrema cautela. Pacientes com hist√≥rico de doen√ßas gastrointestinais, card√≠acas, renais ou hep√°ticas, bem como idosos, apresentam maior risco. Recomenda-se monitorar a fun√ß√£o renal e hep√°tica em tratamentos prolongados. Evitar em pacientes com desidrata√ß√£o grave. O uso concomitante com outros AINEs, anticoagulantes (ex: varfarina), antiagregantes plaquet√°rios (ex: aspirina, clopidogrel) ou corticosteroides aumenta o risco de sangramento. Pode reduzir o efeito de diur√©ticos e anti-hipertensivos. Aconselha-se a menor dose e menor dura√ß√£o poss√≠veis.",
        "Intera√ß√µes Medicamentosas": "O uso concomitante com outros AINEs, anticoagulantes (ex: varfarina), antiagregantes plaquet√°rios (ex: aspirina, clopidogrel) ou corticosteroides aumenta o risco de sangramento. Pode reduzir o efeito de diur√©ticos e anti-hipertensivos."
    },
    {
        "Nome do Medicamento": "Nimesulida",
        "Princ√≠pio(s) Ativo(s)": ["Nimesulida"],
        "Classe Farmacol√≥gica": "Anti-inflamat√≥rio N√£o Esteroidal (AINE) com inibi√ß√£o preferencial da COX-2",
        "Mecanismo de A√ß√£o": "A nimesulida √© um AINE que atua inibindo preferencialmente a enzima ciclooxigenase-2 (COX-2), respons√°vel pela produ√ß√£o de prostaglandinas mediadoras da inflama√ß√£o, dor e febre. Embora tenha alguma afinidade pela COX-1, sua seletividade pela COX-2 √© maior do que a de AINEs n√£o seletivos, o que, teoricamente, poderia reduzir o risco de efeitos adversos gastrointestinais, embora esse benef√≠cio seja controverso e os riscos hep√°ticos sejam uma preocupa√ß√£o particular.",
        "Indica√ß√µes": "Tratamento de dores agudas (ex: dor de garganta, dor de dente, dores p√≥s-operat√≥rias, dismenorreia prim√°ria), inflama√ß√£o (associada a condi√ß√µes como osteoartrite) e febre. √â frequentemente utilizada para condi√ß√µes inflamat√≥rias e dolorosas que requerem um efeito anti-inflamat√≥rio r√°pido.",
        "Posologia": "Adultos: A dose usual √© de 100 mg, duas vezes ao dia. A dura√ß√£o do tratamento deve ser a mais curta poss√≠vel e n√£o deve exceder 15 dias, devido ao risco de hepatotoxicidade. A nimesulida deve ser administrada ap√≥s as refei√ß√µes para minimizar a irrita√ß√£o g√°strica.",
        "Contraindica√ß√µes": "Hipersensibilidade √† nimesulida, a outros AINEs ou a qualquer componente da f√≥rmula; √∫lcera p√©ptica ativa ou hist√≥rico de sangramento/perfura√ß√£o gastrointestinal; hist√≥rico de rea√ß√µes hepatot√≥xicas √† nimesulida; insufici√™ncia hep√°tica (incluindo eleva√ß√£o de transaminases); insufici√™ncia renal grave; insufici√™ncia card√≠aca grave; gravidez (terceiro trimestre) e lacta√ß√£o; crian√ßas menores de 12 anos; uso concomitante de outras subst√¢ncias hepatot√≥xicas ou √°lcool em excesso.",
        "Efeitos Colaterais": "Os efeitos mais comuns incluem dor epig√°strica, n√°useas, v√¥mitos, diarreia, rash cut√¢neo e prurido. O principal e mais grave efeito colateral associado √† nimesulida √© a hepatotoxicidade (les√£o hep√°tica), que pode variar de eleva√ß√µes assintom√°ticas de enzimas hep√°ticas a casos raros, mas graves, de insufici√™ncia hep√°tica aguda, por vezes fatal. Outros efeitos incluem sangramento gastrointestinal, rea√ß√µes al√©rgicas (incluindo anafilaxia) e, menos frequentemente, efeitos renais e cardiovasculares semelhantes a outros AINEs.",
        "Advert√™ncias e Precau√ß√µes": "Devido ao risco significativo de hepatotoxicidade, a nimesulida deve ser utilizada com extrema cautela e sob estrita vigil√¢ncia m√©dica. √â crucial que a dura√ß√£o do tratamento seja a mais curta poss√≠vel e n√£o exceda 15 dias. Pacientes devem ser instru√≠dos a descontinuar o medicamento e procurar atendimento m√©dico imediatamente se desenvolverem sintomas de disfun√ß√£o hep√°tica (ex: n√°useas persistentes, v√¥mitos, dor abdominal, fadiga, icter√≠cia, urina escura). Evitar o uso concomitante com outros AINEs ou medicamentos hepatot√≥xicos. Usar com cautela em pacientes com hist√≥rico de doen√ßas gastrointestinais, cardiovasculares, ou com altera√ß√µes da coagula√ß√£o. Monitorar a fun√ß√£o hep√°tica (transaminases) antes e durante o tratamento, se clinicamente indicado.",
        "Intera√ß√µes Medicamentosas": "Evitar o uso concomitante com outros AINEs ou medicamentos hepatot√≥xicos."
    },
    {
        "Nome do Medicamento": "Omeprazol",
        "Princ√≠pio(s) Ativo(s)": ["Omeprazol"],
        "Classe Farmacol√≥gica": "Inibidor da Bomba de Pr√≥tons (IBP)",
        "Mecanismo de A√ß√£o": "O omeprazol √© um inibidor da bomba de pr√≥tons que atua de forma irrevers√≠vel na H+/K+-ATPase (bomba de pr√≥tons) nas c√©lulas parietais do est√¥mago. Esta bomba √© respons√°vel pela etapa final da secre√ß√£o de √°cido g√°strico. Ao inibir essa bomba, o omeprazol reduz significativamente a produ√ß√£o de √°cido, independentemente do est√≠mulo (alimentos, histamina, gastrina, acetilcolina), proporcionando um controle eficaz da acidez g√°strica.",
        "Indica√ß√µes": "Tratamento da doen√ßa do refluxo gastroesof√°gico (DRGE), incluindo esofagite de refluxo erosiva e n√£o erosiva; cicatriza√ß√£o e preven√ß√£o de recidivas de √∫lceras g√°stricas e duodenais (incluindo √∫lceras associadas ao uso de AINEs); erradica√ß√£o do *Helicobacter pylori* (em combina√ß√£o com antibi√≥ticos apropriados); s√≠ndrome de Zollinger-Ellison (condi√ß√£o rara de hipersecre√ß√£o √°cida); e dispepsia funcional.",
        "Posologia": "Adultos: A dose usual varia de 20 mg a 40 mg, uma vez ao dia, geralmente pela manh√£, antes da primeira refei√ß√£o. Para erradica√ß√£o de *H. pylori*, a dose √© tipicamente de 20 mg duas vezes ao dia, em combina√ß√£o com antibi√≥ticos, por 7 a 14 dias. A dura√ß√£o do tratamento varia conforme a indica√ß√£o, sendo de 4 a 8 semanas para √∫lceras e DRGE, e uso cont√≠nuo para s√≠ndrome de Zollinger-Ellison.",
        "Contraindica√ß√µes": "Hipersensibilidade conhecida ao omeprazol, a outros benzimidaz√≥is substitu√≠dos (ex: pantoprazol, esomeprazol) ou a qualquer componente da f√≥rmula; uso concomitante com nelfinavir (um antiviral) √© contraindicado, pois o omeprazol pode reduzir significativamente a concentra√ß√£o plasm√°tica do nelfinavir.",
        "Efeitos Colaterais": "Os efeitos mais comuns s√£o geralmente leves e transit√≥rios, incluindo cefaleia, dor abdominal, diarreia, n√°useas, v√¥mitos e flatul√™ncia. Efeitos menos comuns podem incluir tontura, erup√ß√µes cut√¢neas, prurido, parestesias (sensa√ß√£o de formigamento) e boca seca. O uso prolongado (especialmente por mais de um ano) tem sido associado a um risco aumentado de fraturas √≥sseas (principalmente de quadril, punho e coluna), defici√™ncia de vitamina B12 (devido √† redu√ß√£o da absor√ß√£o), hipomagnesemia (n√≠veis baixos de magn√©sio no sangue), nefrite intersticial aguda e aumento do risco de infec√ß√µes gastrointestinais (ex: *Clostridium difficile*).",
        "Advert√™ncias e Precau√ß√µes": "Antes de iniciar o tratamento com omeprazol, √© fundamental excluir a possibilidade de malignidade g√°strica (c√¢ncer de est√¥mago), pois o medicamento pode mascarar os sintomas. O uso prolongado (mais de um ano) requer monitoramento m√©dico regular para avaliar os riscos potenciais, como defici√™ncia de B12, hipomagnesemia e fraturas. Pacientes com DRGE cr√¥nica devem ter cautela ao interromper o tratamento, pois pode ocorrer 'rebote' √°cido, com piora dos sintomas. Intera√ß√µes medicamentosas importantes incluem clopidogrel (o omeprazol pode reduzir a efic√°cia antiplaquet√°ria), varfarina (potencial aumento do INR), metotrexato (aumento dos n√≠veis de metotrexato) e medicamentos cuja absor√ß√£o depende do pH g√°strico (ex: cetoconazol, digoxina).",
        "Intera√ß√µes Medicamentosas": "Intera√ß√µes importantes incluem clopidogrel (o omeprazol pode reduzir a efic√°cia antiplaquet√°ria), varfarina (potencial aumento do INR), metotrexato (aumento dos n√≠veis de metotrexato) e medicamentos cuja absor√ß√£o depende do pH g√°strico (ex: cetoconazol, digoxina)."
    },
    {
        "Nome do Medicamento": "Pantoprazol",
        "Princ√≠pio(s) Ativo(s)": ["Pantoprazol S√≥dico Sesqui-hidratado"],
        "Classe Farmacol√≥gica": "Inibidor da Bomba de Pr√≥tons (IBP)",
        "Mecanismo de A√ß√£o": "O pantoprazol, assim como outros IBPs, √© um inibidor seletivo e irrevers√≠vel da H+/K+-ATPase (bomba de pr√≥tons) nas c√©lulas parietais g√°stricas. Ele se liga covalentemente √† bomba, inibindo a secre√ß√£o de √°cido clor√≠drico no l√∫men g√°strico. Sua a√ß√£o √© prolongada e independente do est√≠mulo, proporcionando um controle eficaz da acidez g√°strica e permitindo a cicatriza√ß√£o de les√µes esof√°gicas e g√°stricas.",
        "Indica√ß√µes": "Tratamento da doen√ßa do refluxo gastroesof√°gico (DRGE), incluindo esofagite de refluxo erosiva; cicatriza√ß√£o e preven√ß√£o de recidivas de √∫lceras g√°stricas e duodenais (incluindo √∫lceras induzidas por AINEs); erradica√ß√£o do *Helicobacter pylori* (em combina√ß√£o com antibi√≥ticos); s√≠ndrome de Zollinger-Ellison e outras condi√ß√µes de hipersecre√ß√£o patol√≥gica.",
        "Posologia": "Adultos: A dose usual varia de 20 mg a 40 mg, uma vez ao dia, preferencialmente pela manh√£, antes da primeira refei√ß√£o. Para erradica√ß√£o de *H. pylori*, a dose √© tipicamente de 40 mg duas vezes ao dia, em combina√ß√£o com antibi√≥ticos, por 7 a 14 dias. A dura√ß√£o do tratamento depende da indica√ß√£o e da resposta cl√≠nica, variando de algumas semanas a uso cont√≠nuo em casos espec√≠ficos.",
        "Contraindica√ß√µes": "Hipersensibilidade conhecida ao pantoprazol, a outros benzimidaz√≥is substitu√≠dos ou a qualquer componente da f√≥rmula. O uso concomitante com nelfinavir (um antiviral) √© contraindicado, devido ao risco de redu√ß√£o significativa da concentra√ß√£o plasm√°tica do nelfinavir.",
        "Efeitos Colaterais": "Os efeitos mais comuns s√£o geralmente leves e transit√≥rios, incluindo cefaleia, dor abdominal superior, diarreia, constipa√ß√£o, n√°useas, v√¥mitos e flatul√™ncia. Efeitos menos comuns podem incluir tontura, urtic√°ria, boca seca e rea√ß√µes al√©rgicas. O uso prolongado (especialmente por mais de um ano) tem sido associado a um risco aumentado de fraturas √≥sseas, defici√™ncia de vitamina B12 e hipomagnesemia. H√° tamb√©m um risco potencial, embora raro, de nefrite intersticial aguda e infec√ß√µes por *Clostridium difficile*.",
        "Advert√™ncias e Precau√ß√µes": "√â crucial excluir a possibilidade de malignidade g√°strica antes de iniciar o tratamento com pantoprazol, pois os sintomas podem ser mascarados. O uso prolongado (mais de um ano) requer monitoramento m√©dico regular para avaliar os riscos potenciais associados, como defici√™ncia de B12, hipomagnesemia e fraturas. O pantoprazol tem menos intera√ß√µes medicamentosas clinicamente significativas mediadas pelo CYP2C19 em compara√ß√£o com omeprazol e esomeprazol, o que pode ser uma vantagem em pacientes que usam clopidogrel. No entanto, ainda deve-se ter cautela com medicamentos cuja absor√ß√£o depende do pH g√°strico e com metotrexato (risco de aumento dos n√≠veis).",
        "Intera√ß√µes Medicamentosas": "O pantoprazol tem menos intera√ß√µes clinicamente significativas mediadas pelo CYP2C19 em compara√ß√£o com omeprazol e esomeprazol. Deve-se ter cautela com medicamentos cuja absor√ß√£o depende do pH g√°strico e com metotrexato."
    },
    {
        "Nome do Medicamento": "Esomeprazol",
        "Princ√≠pio(s) Ativo(s)": ["Esomeprazol Magn√©sico", "Esomeprazol S√≥dico"],
        "Classe Farmacol√≥gica": "Inibidor da Bomba de Pr√≥tons (IBP)",
        "Mecanismo de A√ß√£o": "O esomeprazol √© o S-enanti√¥mero do omeprazol e atua como um inibidor seletivo e irrevers√≠vel da H+/K+-ATPase (bomba de pr√≥tons) nas c√©lulas parietais do est√¥mago. Sua formula√ß√£o como S-enanti√¥mero confere-lhe uma maior biodisponibilidade e um perfil farmacocin√©tico mais consistente em compara√ß√£o com o omeprazol, resultando em uma inibi√ß√£o √°cida mais potente e prolongada. Ele bloqueia a etapa final da produ√ß√£o de √°cido, independentemente do est√≠mulo.",
        "Indica√ß√µes": "Tratamento da doen√ßa do refluxo gastroesof√°gico (DRGE), incluindo cicatriza√ß√£o de esofagite erosiva e manuten√ß√£o da cicatriza√ß√£o para prevenir recidivas; tratamento sintom√°tico da DRGE; cicatriza√ß√£o e preven√ß√£o de √∫lceras g√°stricas e duodenais (incluindo as associadas ao uso de AINEs); erradica√ß√£o do *Helicobacter pylori* (em combina√ß√£o com antibi√≥ticos); s√≠ndrome de Zollinger-Ellison e outras condi√ß√µes de hipersecre√ß√£o patol√≥gica.",
        "Posologia": "Adultos: A dose usual varia de 20 mg a 40 mg, uma vez ao dia, preferencialmente pela manh√£, pelo menos uma hora antes da refei√ß√£o. Para erradica√ß√£o de *H. pylori*, a dose √© tipicamente de 20 mg ou 40 mg duas vezes ao dia, em combina√ß√£o com antibi√≥ticos, por 7 a 14 dias. A dura√ß√£o do tratamento √© determinada pela indica√ß√£o e resposta cl√≠nica, variando de algumas semanas a uso cont√≠nuo em condi√ß√µes cr√¥nicas.",
        "Contraindica√ß√µes": "Hipersensibilidade conhecida ao esomeprazol, a outros benzimidaz√≥is substitu√≠dos ou a qualquer componente da f√≥rmula. O uso concomitante com nelfinavir (um antiviral) √© contraindicado, pois o esomeprazol pode reduzir significativamente a concentra√ß√£o plasm√°tica do nelfinavir.",
        "Efeitos Colaterais": "Os efeitos mais comuns s√£o geralmente leves e transit√≥rios, incluindo cefaleia, dor abdominal, diarreia, n√°useas, v√¥mitos e flatul√™ncia. Efeitos menos comuns podem incluir tontura, boca seca, erup√ß√£o cut√¢nea e urtic√°ria. O uso prolongado (especialmente por mais de um ano) tem sido associado a um risco aumentado de fraturas √≥sseas (principalmente de quadril, punho e coluna), defici√™ncia de vitamina B12 e hipomagnesemia. H√° tamb√©m um risco potencial, embora raro, de nefrite intersticial aguda e aumento do risco de infec√ß√µes por *Clostridium difficile*.",
        "Advert√™ncias e Precau√ß√µes": "√â fundamental excluir a possibilidade de malignidade g√°strica antes de iniciar o tratamento com esomeprazol, pois os sintomas podem ser mascarados. O uso prolongado (mais de um ano) requer monitoramento m√©dico regular para avaliar os riscos potenciais associados, como defici√™ncia de B12, hipomagnesemia e fraturas. Pacientes com DRGE cr√¥nica devem ter cautela ao interromper o tratamento, pois pode ocorrer 'rebote' √°cido. O esomeprazol, assim como o omeprazol, pode interagir com o clopidogrel, reduzindo sua efic√°cia antiplaquet√°ria, embora a relev√¢ncia cl√≠nica dessa intera√ß√£o seja debatida e dependa da dose e dura√ß√£o. Outras intera√ß√µes importantes incluem varfarina (potencial aumento do INR), metotrexato (aumento dos n√≠veis de metotrexato) e medicamentos cuja absor√ß√£o depende do pH g√°strico.",
        "Intera√ß√µes Medicamentosas": "O esomeprazol, assim como o omeprazol, pode interagir com o clopidogrel, reduzindo sua efic√°cia antiplaquet√°ria. Outras intera√ß√µes importantes incluem varfarina (potencial aumento do INR), metotrexato (aumento dos n√≠veis de metotrexato) e medicamentos cuja absor√ß√£o depende do pH g√°strico."
    }
];

// Mapeamento dos termos de busca do usu√°rio para as chaves da interface MedicamentoBula
const infoTypeMap: { [key: string]: keyof MedicamentoBula } = {
    "classe terapeutica": "Classe Farmacol√≥gica",
    "posologia": "Posologia",
    "indicacoes": "Indica√ß√µes",
    "efeitos colaterais": "Efeitos Colaterais",
    "contraindicacoes": "Contraindica√ß√µes",
    "mecanismo de acao": "Mecanismo de A√ß√£o",
    "interacoes medicamentosas": "Intera√ß√µes Medicamentosas",
};

/**
 * Fun√ß√£o para buscar informa√ß√µes espec√≠ficas de um medicamento em nossa base de dados est√°tica.
 *
 * @param drugName O nome do medicamento a ser buscado.
 * @param infoType O tipo de informa√ß√£o desejada (ex: "posologia", "efeitos colaterais", "tudo").
 * @returns Uma string contendo a informa√ß√£o solicitada ou uma mensagem de "n√£o encontrado".
 */
export function getMedicamentoInfo(drugName: string, infoType: string): string {
    const termoBuscaMedicamento = drugName.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");

    const medicamentoEncontrado = medicamentosData.find(bula =>
        bula["Nome do Medicamento"].toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").includes(termoBuscaMedicamento)
    );

    if (!medicamentoEncontrado) {
        return `N√£o encontrei informa√ß√µes sobre o medicamento '${drugName}' em nossa base de dados.`;
    }

    // Caso o usu√°rio pe√ßa por "tudo" ou "informa√ß√µes completas"
    if (infoType === "tudo") {
        let fullInfo = `Informa√ß√µes completas sobre **${medicamentoEncontrado["Nome do Medicamento"]}**:\n\n`;
        // Excluir "Nome do Medicamento" e "Advert√™ncias e Precau√ß√µes" para evitar redund√¢ncia e melhorar a leitura.
        const excludedKeys: Array<keyof MedicamentoBula> = ["Nome do Medicamento", "Advert√™ncias e Precau√ß√µes"];

        for (const key in medicamentoEncontrado) {
            const typedKey = key as keyof MedicamentoBula;
            if (!excludedKeys.includes(typedKey)) {
                const value = medicamentoEncontrado[typedKey];
                fullInfo += `* **${key}:** ${Array.isArray(value) ? value.join(', ') : value}\n`;
            }
        }
        return fullInfo;
    }

    const mappedInfoType = infoTypeMap[infoType];

    if (!mappedInfoType) {
        // Se o tipo de informa√ß√£o solicitado n√£o for mapeado
        return `N√£o tenho a informa√ß√£o espec√≠fica sobre '${infoType}' para o medicamento '${medicamentoEncontrado["Nome do Medicamento"]}'. Por favor, tente termos como 'classe terapeutica', 'posologia', 'indicacoes', 'efeitos colaterais', 'contraindicacoes', 'mecanismo de acao', 'interacoes medicamentosas' ou 'tudo'.`;
    }

    const info = medicamentoEncontrado[mappedInfoType];

    if (info) {
        return `* **${mappedInfoType}** do medicamento **${medicamentoEncontrado["Nome do Medicamento"]}**: ${Array.isArray(info) ? info.join(', ') : info}`;
    } else {
        // Se o campo existe na interface mas est√° vazio no dado
        return `N√£o encontrei a informa√ß√£o de '${mappedInfoType}' para o medicamento '${medicamentoEncontrado["Nome do Medicamento"]}'.`;
    }
}